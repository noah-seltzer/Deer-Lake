<!DOCTYPE html>
<html>

<head>
    <title>VegiSmart | Lists</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#ffffff">
    <!--Stylesheets-->
    <link rel="stylesheet" href="style/awesomplete.css" />
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/3/w3.css">
    <link href="style/base.css" rel="stylesheet" type="text/css">
    <link rel="stylesheet" type="text/css" href="style/mobile.css" />
    <!-- Bootstrap 4 alpha CSS -->
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.4/css/bootstrap.min.css" rel="stylesheet">
    <!-- Custom Fonts -->

    <link href="https://fonts.googleapis.com/css?family=Montserrat|Open+Sans|Roboto" rel="stylesheet">
    <!-- Fav Icons-->
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="manifest" href="manifest.json">
    <link rel="mask-icon" href="safari-pinned-tab.svg" color="#5bbad5">
    <script src="awesomplete.js" async></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.3.3/vue.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/3.9.0/firebase.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vuefire/1.4.2/vuefire.min.js"></script>
</head>

<body>
    <!-- Slideout menu -->
    <nav id="menu">
        <header>
            <ul class="menuVertical">
                <div id="menuHeader"><img src="images/Icon%20Assets/logo_ver3xhdpi.png"></div>
                <div class="menuLinks">
                    <a href="index.html">
                        <li><img class="menuIcon" src="images/Icon%20Assets/menuHome.png"> <span class="menuPageNames">Home</span></li>
                    </a>
                </div>
                <hr>
                <div class="menuLinks">
                    <a href="lists.html">
                        <li><img class="menuIcon" src="images/Icon%20Assets/menuList.png"> <span class="menuPageNames">My List</span> </li>
                    </a>
                </div>
                <hr>
                <div class="menuLinks">
                    <a href="fridge.html">
                        <li><img class="menuIcon" id="fridgeIcon" src="images/Icon%20Assets/menuFridge.png"> <span class="menuPageNames">My Fridge</span></li>
                    </a>
                </div>
                <hr>
                <div class="menuLinks">
                    <a href="stats.html">
                        <li><img class="menuIcon" id="statsIcon" src="images/Icon%20Assets/menuStats.png"> <span class="menuPageNames">Reports</span></li>
                    </a>
                </div>
                <hr>
                <div class="menuLinks">
                    <a href="info.html">
                        <li><img class="menuIcon" id="infoIcon" src="images/Icon%20Assets/menuInfo.png"> <span class="menuPageNames">Info & Tips</span></li>
                    </a>
                </div>
                <hr>
                <div class="menuLinks">
                    <a href="login.html">
                        <li><img class="menuIcon" id="loginIcon" src="images/Icon%20Assets/menuLogin.png"> <span class="menuPageNames">Login</span></li>
                    </a>
                </div>
                <hr> </ul>
        </header>
    </nav>
    <!-- main page content area -->
    <!-- header -->
    <main id="panel">
        <header>
            <!-- Top Navigation -->
            <div class="topNav">
                <div class="menuButton">
                    <button class="toggle-button"><img src="images/Icon%20Assets/menu.png"></button>
                </div>
                <div class="menuTitle">
                    <h1 id="navTitle"><i class="fa fa-home" aria-hidden="true"></i> My Lists</h1>
                </div>
                <div class="menuRight">
                    <div id="sign-in-status"></div>
                    <button class="signOutButton" onclick="toggleSignIn()">
                        <div id="sign-in"></div>
                    </button>
                    <!--<div id="account-details"></div>--></div>
            </div>
        </header>
        <!--
    <div id="container">
        <div class="contentWrap">
            <div id="center">
                <i class="fa fa-plus" aria-hidden="true"></i>
                <input type="text" v-on:keyup.enter="addList" v-model="newListText" id="addAnItem" placeholder="Add A List"> </div>

            <div id="infoText">





                <template v-for="(list,index) in lists">

       <a :href="'#' + 'my'+ index" class="" data-toggle="collapse"> <h3 id="info" >

           {{list.name}}
           <i id="carat" class="fa fa-caret-down" aria-hidden="true"></i>
           </h3></a><br>


          <div v-bind:id=" 'my' + index" class="collapse" v-bind:class="noCollapse(index)">




              <div id="right" ><a @click="removeList(index)" id="removeList"href="#"><i class="fa fa-times" aria-hidden="true"></i> Remove List</a></div>


          <div v-if="list.lunch.length > 0" >
                <a @click="checkAll(index)" href="#" id="selectAll"><i class="fa fa-check-square checkAll" aria-hidden="true"></i> Select All</a>
            </div>

          <template >


           <ul id="">


                <li @click="checkIt(index, index2)" id="listItem" v-for="(item,index2) in list.lunch">

                     <i v-if="!item.checked" class="fa fa-square-o" aria-hidden="true"></i>
                    <i v-else class="fa fa-check-square-o" aria-hidden="true"></i>


                    <span v-if="item.checked"><s>
                        <span v-if="item.quantity != 0">{{item.quantity}}</span>  {{item.item}}</s></span>

                    <span v-else> <span v-if="item.quantity != 0">{{item.quantity}}</span> {{item.item}}</span>

                </li>
            </ul>








          </template>
                <div id="buttons">
                    <button v-if="anyChecked(index)" type="button" class="btn btn-sm">Add To Fridge</button>
                    <button v-if="anyChecked(index)" type="button" class="btn btn-sm" @click="remove(index)">Remove</button>


                </div>
            </div>
            </template>
        </div>
    </div>
    </div>
-->
        <div id="container">
            <!--
        <div id="center">
            <i class="fa fa-plus" aria-hidden="true"></i>
            <input type="text" id="addAnItem" placeholder="Add A List" v-model.trim="newListName" @keyup.enter="addList"> </div>
-->
            <div id="center">
                <h3 id="info">Fruits
                </h3>

                <div class="alert alert-success" style="display:none" role="alert">
                    <strong style="text-align:center">You have added:</strong>
                    <button type="button" class="close" @click="closeAlert()" aria-hidden="true">&times;</button>
                    <p id="addedItems"></p>

                </div>

                <input id="addAnItem" placeholder="Add An Item" v-model.trim="newTodoTextF" @keyup.enter="addTodoF()" placeholder="Add new todo">
            </div>
            <ul>
                <template v-for="todo in fruits">
                    <li @click="checkIt(todo, fruitsRef)" id="listItem"> <template v-if="!todo.checked">
                        <i  class="fa fa-square-o" aria-hidden="true"></i> 
                            {{todo['.key']}}
                        </template>
                <template v-else>
                        <i class="fa fa-check-square-o" aria-hidden="true"></i> 
                        <span style="text-decoration:line-through">
                            {{todo['.key']}} 
                            </span>
                        </template> </li>
                </template>
                <div id="buttons">
                    <button v-if="anyChecked(fruitsRef)" type="button" @click="addToFridge(fruits)" class="btn btn-sm">Add To Fridge</button>
                    <button v-if="anyChecked(fruitsRef)" type="button" class="btn btn-sm" @click="removeChecked(fruits, fruitsRef)">Remove</button>
                </div>
            </ul>
            <!--             END FRUITS-->
            <div id="center">
                <h3 id="info">Vegetables
                </h3>
                <input id="addAnItem2" placeholder="Add An Item" v-model.trim="newTodoTextV" @keyup.enter="addTodoV()" placeholder="Add new todo"> </div>
            <ul>
                <template v-for="todo in vegs">
                    <li @click="checkIt(todo, vegRef)" id="listItem">
                        <template v-if="!todo.checked">
                        <i  class="fa fa-square-o" aria-hidden="true"></i> 
                            {{todo['.key']}}
                        </template>
                <template v-else>
                        <i class="fa fa-check-square-o" aria-hidden="true"></i> 
                        <span style="text-decoration:line-through">
                            {{todo['.key']}} 
                            </span>
                        </template>
                </li>
                </template>
                <div id="buttons">
                    <button v-if="anyChecked(vegRef)" type="button" @click="addToFridge(vegs)" class="btn btn-sm">Add To Fridge</button>
                    <button v-if="anyChecked(vegRef)" type="button" class="btn btn-sm" @click="removeChecked(vegs, vegRef)">Remove</button>
                </div>
            </ul>
        </div>
    </main>
</body>
<!-- jQuery library -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.0.0/jquery.min.js" integrity="sha384-THPy051/pYDQGanwU6poAc/hOdQxjnOEXzbT+OuUAFqNqFjL+4IGLBgCJC3ZOShY" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<!-- Tether -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.2.0/js/tether.min.js" integrity="sha384-Plbmg8JY28KFelvJVai01l8WyZzrYWG825m+cZ0eDDS1f7d/js6ikvy1+X+guPIB" crossorigin="anonymous"></script>
<!-- Bootstrap 4 Alpha JS -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.4/js/bootstrap.min.js" integrity="sha384-VjEeINv9OSwtWFLAtmc4JCtEJXXBub00gtSnszmspDLCtC0I4z4nqz7rEFbIZLLU" crossorigin="anonymous"></script>
<script src="https://use.fontawesome.com/26ec5e6edd.js"></script>
<!-- Initialize Bootstrap functionality -->
<script>
    // Initialize tooltip component
    $(function() {
        $('[data-toggle="tooltip"]').tooltip()
    })
    // Initialize popover component
    $(function() {
        $('[data-toggle="popover"]').popover()
    })

</script>
<!-- slideout menu component -->
<script src="dist/slideout.min.js"></script>
<script>
    var element = document.getElementById('menuHeader'),
        style = window.getComputedStyle(element),
        size = style.getPropertyValue('width');
    var slideout = new Slideout({
        'panel': document.getElementById('panel'),
        'menu': document.getElementById('menu'),
        'padding': size,
        'tolerance': 70
    });
    document.querySelector('.toggle-button').addEventListener('click', function() {
        slideout.toggle();
    });

</script>

<!--Firebase component-->
<script src="https://www.gstatic.com/firebasejs/3.9.0/firebase.js"></script>
<script>
    // Initialize Firebase
    var config = {
        apiKey: "AIzaSyB8DpIYhyJi5b_p3LrQcycvMuM-h5aH08Y",
        authDomain: "vegismart-9265b.firebaseapp.com",
        databaseURL: "https://vegismart-9265b.firebaseio.com",
        projectId: "vegismart-9265b",
        storageBucket: "vegismart-9265b.appspot.com",
        messagingSenderId: "37856046364"
    };
    firebase.initializeApp(config);

</script>
<script>
    var fruitsRef;
    var listsRef;
    var vegRef;
    var uid;

    function toggleSignIn() {
        if (firebase.auth().currentUser) {
            // [START signout]
            firebase.auth().signOut();
            // [END signout]
        } else {
            window.location.replace("login.html");
        }
        document.getElementById('sign-in').disabled = true;
    }
    $('document').ready(function() {
        initApp();
    });

    function initApp() {
        // Listening for auth state changes.
        // [START authstatelistener]
        firebase.auth().onAuthStateChanged(function(user) {
            if (user) {
                // User is signed in.
                firebase.database().ref('users/' + user.uid + '/displayName').once('value').then(function(snapshot) {
                    var displayName = snapshot.val();
                    var email = user.email;
                    uid = user.uid;
                    var providerData = user.providerData;
                    var emailVerified = user.emailVerified;
                    var photoURL = user.photoURL;
                    user.getToken().then(function(accessToken) {
                        document.getElementById('sign-in-status').textContent = user.displayName;
                        document.getElementById('sign-in').textContent = 'Sign out';
                        $('#sign-in-status').text(displayName);
                    });
                    fruitsRef = firebase.database().ref('users/' + uid + '/Lists/Fruits');
                    listsRef = firebase.database().ref('users/' + uid + '/Lists');
                    vegRef = firebase.database().ref('users/' + uid + '/Lists/Vegetables');
                    createVue();
                    predictText();
                });
            } else {
                // User is signed out.
                document.getElementById('sign-in-status').textContent = 'Signed out';
                document.getElementById('sign-in').textContent = 'Sign in';
                createVueOffline();
            }
        }, function(error) {
            console.log(error);
        });
    }

    function createVue() {
        new Vue({
            el: '#container',
            data: {
                newTodoTextF: '',
                newTodoTextV: '',
                newListName: '',
                listName: fruitsRef.getKey(),
                todo: 'a'
            },
            firebase: {
                fruits: fruitsRef.limitToLast(25),
                lists: listsRef.limitToLast(25),
                vegs: vegRef.limitToLast(25)
            },
            methods: {
                addTodoF: function() {
                    if (this.newTodoTextF) {
                        var awsElements = $('.awesomplete > ul > li');
                        for (var i = 0; i < awsElements.length; i++) {
                            if ($(awsElements[i]).attr("aria-selected") == 'true') {
                                this.newTodoTextF = $(awsElements[i]).text();
                            }
                        }
                        firebase.database().ref('users/' + uid + '/Lists/Fruits/' + this.newTodoTextF).update({
                            checked: false
                        })

                        //Add to predictive text list
                        firebase.database().ref('users/' + uid + '/pastItems').update({
                            [this.newTodoTextF]: true
                        })

                        this.newTodoTextF = ''
                        predictObj.close();
                    }
                },
                addTodoV: function() {
                    if (this.newTodoTextV) {
                        var awsElements = $('.awesomplete > ul > li');
                        for (var i = 0; i < awsElements.length; i++) {
                            if ($(awsElements[i]).attr("aria-selected") == 'true') {
                                this.newTodoTextV = $(awsElements[i]).text();
                            }
                        }
                        firebase.database().ref('users/' + uid + '/Lists/Vegetables/' + this.newTodoTextV).update({
                            checked: false
                        })

                        //Add to predictive text list
                        firebase.database().ref('users/' + uid + '/pastItems').update({
                            [this.newTodoTextV]: true
                        })

                        this.newTodoTextV = ''
                        predictObj2.close();
                    }
                },
                addList: function() {
                    if (this.newListName) {
                        listsRef.update({
                            name: this.newListName
                        })
                        this.newListName = ''
                    }
                },
                removeTodo: function(todo, ref) {
                    ref.child(todo['.key']).remove()
                },
                checkIt: function(todo, ref) {
                    ref.once("value", function(snapshot) {
                        var i = snapshot.child(todo['.key']).child('checked').val();
                        if (i) ref.child(todo['.key']).child('checked').set(false)
                        else ref.child(todo['.key']).child('checked').set(true)
                    });
                },
                anyChecked: function(ref) {
                    return true;
                },
                removeChecked: function(items, ref) {
                    for (i = 0; i < items.length; i++) {
                        if (items[i].checked) {
                            var v = items[i]
                            ref.child(v['.key']).remove()
                            i--
                        }
                    }
                },
                updateTodoText: function(todo, newText) {
                    todosRef.child(todo['.key']).child('text').set(newText)
                }, //TODO
                addToFridge: function(items) {
                    var added = [];


                    for (i = 0; i < items.length; i++) {
                        if (items[i].checked) {
                            var v = items[i]
                            added.push(v['.key'])


                            var quantity = this.getQuantity(v['.key'])
                            var large = this.getLarge(quantity)
                            var name = this.getName(large, v['.key'])
                            var fridgeRef = firebase.database().ref('users/' + uid + '/fridge/' + name)
                            var statsRef = firebase.database().ref('users/' + uid + '/stats/totalQuantity/' + name)
                            var statsRef2 = firebase.database().ref('users/' + uid + '/stats/totalQuantity')
                            var existingQuantity = this.getExistingQuantity(fridgeRef);

                             fridgeRef.once("value", function(snapshot) {
                                var x = 0;
                                if(snapshot.val())
                                {x = snapshot.val().quantity}
                                fridgeRef.update({
                                    quantity:quantity + x,
                                    large:large
                                })
                                  statsRef2.update({
                                    [name]:quantity + x

                                })

                            })
                             
//                            statsRef.once("value", function(snapshot) {
//                                var x = 0;
//                                if(snapshot.val())
//                                {x = snapshot.val()}
//                                console.log("x is" + x)
//                                statsRef2.update({
//                                    [name]:quantity + x
//
//                                })
//
//                            })



//                            if (existingQuantity) {
//                                fridgeRef.update({
//
//                                    quantity: quantity + existingQuantity,
//                                    large: large
//                                })
//                            } else {
//                                fridgeRef.update({
//
//                                    quantity: quantity,
//                                    large: large
//                                })
//                            }

                        }

                    }
                    $('#addedItems').append(added.toString() + ', ')
                    $('.alert').show()




                },

                closeAlert: function() {
                    $('.alert').hide()
                    $("#addedItems").html('')

                },
                getQuantity: function(str) {
                    var ret = parseInt(str.split(' ').slice(0, 1).toString())
                    if (isNaN(ret)) return 100
                    else return ret
                },
                getLarge: function(num) {
                    return (num == 100)
                },
                getExistingQuantity: function(ref) {
                    var x;

                    //                     ref.once('value').then(function(snapshot){
                    //                          x = snapshot.val().quantity
                    //                      })
                    ref.on("value", function(snapshot) {
                        x = snapshot.val().quantity

                    })

                    return x


                },
                getName: function(l, name) {
                    if (l) {
                        return name
                    } else {
                        return name.split(' ').slice(1).toString()
                    }

                }
            }
        });
    }

    //Global predictive text object
    var predictObj;
    var predictObj2;

    function predictText() {
        var input = document.getElementById("addAnItem");
        predictObj = new Awesomplete(input, {
            list: ''
        });
        var input2 = document.getElementById("addAnItem2");
        predictObj2 = new Awesomplete(input2, {
            list: ''
        });
        firebase.database().ref('users/' + uid + '/pastItems/').on('value',
            function(snapshot) {
                var keys = Object.keys(snapshot.val());
                predictObj.list = keys;
                predictObj2.list = keys;
            });
    }

    //This vue object is used for offline storage
    /*
     function createVueOffline(){
     var vueOffline = new Vue({
     el: '#container',
     data: {
     newTodoTextF: '',
     newTodoTextV: '',
     newListName: '',
     //listName: fruitsRef.getKey()


     },

     firebase: {
     fruits: fruitsRef.limitToLast(25),
     lists: listsRef.limitToLast(25),
     vegs: vegRef.limitToLast(25)



     },
     methods: {
     addTodoF: function() {

     if (this.newTodoTextF) {
     fruitsRef.update({
     text: this.newTodoTextF,
     checked: false
     })
     this.newTodoTextF = ''
     }
     },
     addTodoV: function() {



     if (this.newTodoTextV) {
     vegRef.update({
     text: this.newTodoTextV,
     checked: false
     })
     this.newTodoTextV = ''
     }
     },
     addList: function() {
     if (this.newListName) {
     listsRef.update({
     name: this.newListName
     })
     this.newListName = ''
     }


     },
     removeTodo: function(todo, ref) {
     ref.child(todo['.key']).remove()
     },

     checkIt: function(todo, ref) {


     ref.once("value", function(snapshot) {


     var i = snapshot.child(todo['.key']).child('checked').val();
     if (i) ref.child(todo['.key']).child('checked').set(false)
     else
     ref.child(todo['.key']).child('checked').set(true)


     }

     );



     },
     anyChecked: function(ref) {
     return true;

     },
     removeChecked: function(items, ref) {



     for (i = 0; i < items.length; i++) {

     if (items[i].checked) {
     var v = items[i]
     ref.child(v['.key']).remove()
     i--
     }
     }




     },


     updateTodoText: function(todo, newText) {
     todosRef.child(todo['.key']).child('text').set(newText)
     },

     //TODO
     addToFridge: function() {

     }
     }
     });
     }
     */

</script>
