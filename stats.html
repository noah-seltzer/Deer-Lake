<!DOCTYPE html>
<html>

<head>
    <title>VegiSmart | Stats</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#ffffff">
    <!--StyleSheets -->
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/3/w3.css">
    <link href="style/base.css" rel="stylesheet" type="text/css">
    <link href="style/stat1.css" rel="stylesheet" type="text/css">
    <link rel="stylesheet" type="text/css" href="style/mobile.css" />
    <!-- Bootstrap 4 alpha CSS -->
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.4/css/bootstrap.min.css" rel="stylesheet">
    <!-- Custom Fonts -->
    <link href="vendor/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Montserrat|Open+Sans|Roboto" rel="stylesheet">
    <!-- Fav Icons-->
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="manifest" href="manifest.json">
    <link rel="mask-icon" href="safari-pinned-tab.svg" color="#5bbad5"> </head>

<body>
    <!-- Slideout menu -->
    <nav id="menu">
        <header>
            <ul class="menuVertical">
                <div id="menuHeader"><img src="images/Icon%20Assets/logo_ver3xhdpi.png"></div>
                <div class="menuLinks">
                    <a href="index.html">
                        <li><img class="menuIcon" src="images/Icon%20Assets/menuHome.png"> <span class="menuPageNames">Home</span></li>
                    </a>
                </div>
                <hr>
                <div class="menuLinks">
                    <a href="lists.html">
                        <li><img class="menuIcon" src="images/Icon%20Assets/menuList.png"> <span class="menuPageNames">My List</span> </li>
                    </a>
                </div>
                <hr>
                <div class="menuLinks">
                    <a href="fridge.html">
                        <li><img class="menuIcon" id="fridgeIcon" src="images/Icon%20Assets/menuFridge.png"> <span class="menuPageNames">My Fridge</span></li>
                    </a>
                </div>
                <hr>
                <div class="menuLinks">
                    <a href="stats.html">
                        <li><img class="menuIcon" id="statsIcon" src="images/Icon%20Assets/menuStats.png"> <span class="menuPageNames">Reports</span></li>
                    </a>
                </div>
                <hr>
                <div class="menuLinks">
                    <a href="info.html">
                        <li><img class="menuIcon" id="infoIcon" src="images/Icon%20Assets/menuInfo.png"> <span class="menuPageNames">Info & Tips</span></li>
                    </a>
                </div>
                <hr>
                <div class="menuLinks">
                    <a href="login.html">
                        <li><img class="menuIcon" id="loginIcon" src="images/Icon%20Assets/menuLogin.png"> <span class="menuPageNames">Login</span></li>
                    </a>
                </div>
                <hr> </ul>
        </header>
    </nav>
    <!-- main page content area -->
    <!-- header -->
    <main id="panel">
        <header>
            <div class="topNav">
                <div class="menuButton">
                    <button class="toggle-button"><img src="images/Icon%20Assets/menu.png"></button>
                </div>
                <div class="menuTitle">
                    <h1 id="navTitle"><i class="fa fa-line-chart" aria-hidden="true"></i> My Stats</h1> </div>
                <div class="menuRight">
                    <div id="sign-in-status"></div>
                    <button class="signOutButton" onclick="toggleSignIn()">
                        <div id="sign-in"></div>
                    </button>
                    <!--<div id="account-details"></div>--></div>
            </div>
        </header>
        <div class="container" id="container">
            <div class="row">
                <div class="card">
                    <div id="testing"></div>
                </div>
            </div>
            <div class="row">
                <div class="card">
                    <div class="lineChart">
                        <div class="lineChartMessage"> {{ message }} Average Monthly Consumption </div>
                        <line-chart></line-chart>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="card">
                    <div class="radarChart">
                        <div class="radarChartMessage"> {{ message }} Top 7 Food Consumption </div>
                        <radar-chart></radar-chart>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="card">
                    <div class="doughnutChart">
                        <div class="doughnutChartMessage"> {{ message }} Apple </div>
                        <doughnut-chart></doughnut-chart>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="card">
                    <div class="bigText" v-model="max" @click="computeTotalWasted">{{"$ " + totalWasted}} </div>
                    <br>
                    <br> <small>*Cost determined by Superstore's current pricing</small> </div>
            </div>
            <div class="row">
                <div class="card"> <img id="bigFoodIcon" src="images/apple.png" alt="Apple">
                    <div class="medText" v-model="max" @click="computeTopWasted">{{maxname + "s"}}</div> You have wasted
                    <div class="smallText" v-model="max" @click="computeTopWasted">{{max}} </div> {{maxname + "s"}}. </div>
            </div>
            <div class="row">
                <div class="card">
                    <div class="medText" v-model="max" @click="computeTopWasted">{{secondname + "s"}}</div> You have wasted
                    <div class="smallText" v-model="max" @click="computeTopWasted">{{secondmax}}</div> {{secondname + "s"}}.
                    <div class="medText" v-model="max" @click="computeTopWasted">{{thirdname + "s"}}</div> You have wasted
                    <div class="smallText" v-model="max" @click="computeTopWasted">{{thirdmax}}</div> {{thirdname }}. </div>
            </div>
        </div>
    </main>
</body>
<!-- slideout menu component -->
<script src="dist/slideout.min.js"></script>
<script>
    var element = document.getElementById('menuHeader')
        , style = window.getComputedStyle(element)
        , size = style.getPropertyValue('width');
    var slideout = new Slideout({
        'panel': document.getElementById('panel')
        , 'menu': document.getElementById('menu')
        , 'padding': size
        , 'tolerance': 70
    });
    document.querySelector('.toggle-button').addEventListener('click', function () {
        slideout.toggle();
    });
</script>
<!-- jQuery library -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.0.0/jquery.min.js" integrity="sha384-THPy051/pYDQGanwU6poAc/hOdQxjnOEXzbT+OuUAFqNqFjL+4IGLBgCJC3ZOShY" crossorigin="anonymous"></script>
<!-- Tether -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.2.0/js/tether.min.js" integrity="sha384-Plbmg8JY28KFelvJVai01l8WyZzrYWG825m+cZ0eDDS1f7d/js6ikvy1+X+guPIB" crossorigin="anonymous"></script>
<!-- Bootstrap 4 Alpha JS -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.4/js/bootstrap.min.js" integrity="sha384-VjEeINv9OSwtWFLAtmc4JCtEJXXBub00gtSnszmspDLCtC0I4z4nqz7rEFbIZLLU" crossorigin="anonymous"></script>
<!--Font Awesome stuff -->
<script src="https://use.fontawesome.com/26ec5e6edd.js"></script>
<!--Vue Js-->
<script src="vue.js"></script>
<script type="text/javascript">
    new Vue({
        el: '#container'
        , data: {
            //most wasted food
            max: 0, //second most wasted food
            secondmax: 0, // third most wasted food... etc.
            thirdmax: 0, //name of the max wasted food
            maxname: '', // Total wasted amount(cost)
            totalWasted: 0
            , secondname: ''
            , thirdname: '', //objects to be pulled from server
            items: [{
                quantityWasted: 5
                , item: "Apple"
                , cost: 0.87
            }, {
                quantityWasted: 1
                , item: "Egg"
                , cost: 0.3
            }, {
                quantityWasted: 4
                , item: "Banana"
                , cost: 0.71
            }]
        , }
        , computed: {
            //computes top wasted foods
            computeTopWasted: function () {
                for (i = 0; i < this.items.length; i++) {
                    if (this.items[i].quantityWasted > this.max) {
                        this.thirdmax = this.secondmax;
                        this.thirdname = this.secondname;
                        this.secondmax = this.max;
                        this.secondname = this.maxname;
                        this.max = this.items[i].quantityWasted;
                        this.maxname = this.items[i].item;
                    }
                    else if (this.items[i].quantityWasted > this.secondmax) {
                        this.thirdmax = this.secondmax;
                        this.thirdname = this.secondname;
                        this.secondmax = this.items[i].quantityWasted;
                        this.secondname = this.items[i].item;
                    }
                    else if (this.items[i].quantityWasted > this.thirdmax) {
                        this.thirdmax = this.items[i].quantityWasted;
                        this.thirdname = this.items[i].item;
                    }
                }
            }, // computes total wasted food
            computeTotalWasted: function () {
                for (i = 0; i < this.items.length; i++) {
                    this.totalWasted += (this.items[i].quantityWasted * this.items[i].cost);
                }
                this.totalWasted = this.totalWasted.toFixed(2);
            }
        , }
    , });
</script>
<!-- Initialize Bootstrap functionality -->
<script>
    // Initialize tooltip component
    $(function () {
            $('[data-toggle="tooltip"]').tooltip()
        })
        // Initialize popover component
    $(function () {
        $('[data-toggle="popover"]').popover()
    })
</script>
<!--Firebase component-->
<script src="https://www.gstatic.com/firebasejs/3.9.0/firebase.js"></script>
<script>
    // Initialize Firebase
    var config = {
        apiKey: "AIzaSyB8DpIYhyJi5b_p3LrQcycvMuM-h5aH08Y"
        , authDomain: "vegismart-9265b.firebaseapp.com"
        , databaseURL: "https://vegismart-9265b.firebaseio.com"
        , projectId: "vegismart-9265b"
        , storageBucket: "vegismart-9265b.appspot.com"
        , messagingSenderId: "37856046364"
    };
    firebase.initializeApp(config);
</script>
<!-- firebaseUI for user authentication -->
<script src="https://cdn.firebase.com/libs/firebaseui/1.0.1/firebaseui.js"></script>
<link type="text/css" rel="stylesheet" href="https://cdn.firebase.com/libs/firebaseui/1.0.1/firebaseui.css" />
<!-- Firebase Auth state track and display on each page-->
<script type="text/javascript">
    // Global variables for reference
    var statsRef;
    var totalQuantityRef;
    var vegRef;
    var uid;
    var displayName;
    var email;
    var key;
    var top5FruitKey = [];
    var top5FruitVal = [];
    var top5VegKey = [];
    var top5VegVal = [];
    var top5FruitConsumed = [];
    var top5FruitConsumedVal = [];
    var top5VegConsumed = [];
    var top5VegConsumedVal = [];
    var top5FruitWasted = [];
    var top5FruitWastedVal = [];
    var top5VegWasted = [];
    var top5VegWastedVal = [];

    function toggleSignIn() {
        if (firebase.auth().currentUser) {
            // [START signout]
            firebase.auth().signOut();
            // [END signout]
        }
        else {
            window.location.replace("login.html");
        }
        document.getElementById('sign-in').disabled = true;
    }
    initApp = function () {
        firebase.auth().onAuthStateChanged(function (user) {
            if (user) {
                // User is signed in.
                displayName = user.displayName;
                email = user.email;
                uid = user.uid;
                var qIndex = 0;
                var cIndex = 0;
                var wIndex = 0;
                //stat references
                totalQuantityRef = firebase.database().ref('users/' + uid + '/Stat2/totalQuantity');
                totalConsumedRef = firebase.database().ref('users/' + uid + '/Stat2/totalConsumed');
                totalWastedRef = firebase.database().ref('users/' + uid + '/Stat2/totalWasted');
                // Sort, search top 5 fruit bought
                totalQuantityRef.orderByValue().limitToLast(5).once('value').then(function (data) {
                    data.forEach(function (data) {
                        console.log(data.key + ": " + data.val());
                        top5FruitKey[qIndex] = data.key;
                        top5FruitVal[qIndex] = data.val();
                        qIndex++;
                    });
                    console.log(top5FruitKey[0]);
                    document.getElementById('testing').textContent = top5FruitKey[3];
                });
                // Sort, search top 5 fruit consumed
                totalConsumedRef.orderByValue().limitToLast(5).once('value').then(function (data) {
                    data.forEach(function (data) {
                        top5FruitConsumed[cIndex] = data.key;
                        top5FruitConsumedVal[cIndex] = data.val();
                        cIndex++;
                    });
                    console.log(top5FruitConsumed);
                });
                // Sort, search top 5 fruit wasted
                totalWastedRef.orderByValue().limitToLast(5).once('value').then(function (data) {
                    data.forEach(function (data) {
                        top5FruitWasted[wIndex] = data.key;
                        top5FruitWastedVal[wIndex] = data.val();
                        wIndex++;
                    });
                    console.log(top5FruitWasted);
                    initCharts();
                });
                user.getToken().then(function (accessToken) {
                    document.getElementById('sign-in-status').textContent = email;
                    document.getElementById('sign-in').textContent = 'Sign out';
                });
            }
            else {
                // User is signed out.
                document.getElementById('sign-in-status').textContent = 'Signed out';
                document.getElementById('sign-in').textContent = 'Sign in';
            }
        }, function (error) {
            console.log(error);
        });
    };
    window.addEventListener('load', function () {
        initApp();
    });
</script>
<!-- Chart component -->
<script src="https://unpkg.com/vue-chartjs@2.6.0/dist/vue-chartjs.full.min.js"></script>
<script>
    function initCharts() {
        //        lineChart
        Vue.component('line-chart', {
            extends: VueChartJs.Line
            , mounted() {
                this.gradient = this.$refs.canvas.getContext('2d').createLinearGradient(0, 0, 0, 450)
                this.gradient.addColorStop(0, 'rgba(255, 0,0, 0.5)')
                this.gradient.addColorStop(0.5, 'rgba(255, 0, 0, 0.25)');
                this.gradient.addColorStop(1, 'rgba(255, 0, 0, 0)');
                this.renderChart({
                    //need to make reactive, show only last 3-4months?
                    labels: [top5FruitKey[0], top5FruitKey[1], top5FruitKey[2], top5FruitKey[3], top5FruitKey[4]]
                    , datasets: [
                        {
                            label: 'UserName', //need to make reactive
                            pointBackgroundColor: 'white'
                            , borderWidth: 1
                            , pointBorderColor: 'white'
                            , backgroundColor: this.gradient
                            , data: [top5FruitVal[0], top5FruitVal[1], top5FruitVal[2], top5FruitVal[3], top5FruitVal[4]] //need to make reactive
        }
      ]
                }, {
                    responsive: true
                    , maintainAspectRatio: true
                })
            }
        })
        Vue.component('radar-chart', {
            extends: VueChartJs.Radar
            , mounted() {
                this.renderChart({
                    labels: [top5FruitConsumed[0], top5FruitConsumed[1], top5FruitConsumed[2], top5FruitConsumed[3], top5FruitConsumed[4]]
                    , datasets: [
                        {
                            label: '', //need to make reactive
                            backgroundColor: '#00b74f'
                            , data: [top5FruitConsumedVal[0],top5FruitConsumedVal[1], top5FruitConsumedVal[2],top5FruitConsumedVal[3],top5FruitConsumedVal[4]] // need to make reactive
        }
      ]
                }, {
                    responsive: true
                    , maintainAspectRatio: true
                })
            }
        })
        var numConsumed = top5FruitVal[3];
        var numWasted = 100 - top5FruitVal[3];
        console.log(numConsumed + ": " + top5FruitVal[3]);
        Vue.component('doughnut-chart', {
            extends: VueChartJs.Doughnut
            , mounted() {
                this.renderChart({
                    labels: ['Consumed', '']
                    , datasets: [
                        {
                            label: 'UserName'
                            , backgroundColor: ['#00b74f', '#FFFFFF']
                            , data: [numConsumed, numWasted] //need to make reactive
                                
                            , cutoutPercentage: '90'
                            , borderColor: ['#00b74f', 'white']
        }
      ]
                }, {
                    responsive: true
                    , maintainAspectRatio: false
                })
            }
        })
        var vm = new Vue({
            el: '.lineChart'
            , data: {
                message: 'line'
            }
        })
        var vm = new Vue({
            el: '.radarChart'
            , data: {
                message: 'radar'
            }
        })
        var vm = new Vue({
            el: '.doughnutChart'
            , data: {
                message: 'doughnut'
            }
        })
    }
</script>